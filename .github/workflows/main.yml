name: Docker Image Sign and Push to ACR

on:
  push:
    branches:
      - main

jobs:
  build-sign-push-to-acr:
    runs-on: ubuntu-latest

    env:
      REGISTRY: everestdemocontainerregistry.azurecr.io
      IMAGE_NAME: pa-submission-api
      IMAGE_TAG: sha256:b8e80df8f361152ce9f0bc2d0ac683f96774f998d47ed99648b5659722e03145

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Log in to Azure Container Registry
      uses: docker/login-action@v1
      with:
        registry: ${{ secrets.ACR_REGISTRY }}
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}

    - name: Pull image from ACR
      run: |
        docker pull everestdemocontainerregistry.azurecr.io/pa-submission-workflow-api@sha256:b8e80df8f361152ce9f0bc2d0ac683f96774f998d47ed99648b5659722e03145

    - name: cosign-installer
      uses: sigstore/cosign-installer@v2.2.0  
      with:
        cosign-release: v2.2.0  

    - name: Sign the pulled image
      run: |
        cosign sign --key cosign.key everestdemocontainerregistry.azurecr.io/pa-submission-workflow-api@sha256:b8e80df8f361152ce9f0bc2d0ac683f96774f998d47ed99648b5659722e03145
      env:
        COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
        
    - name: Tag Docker image for ACR
      run: |
        docker tag everestdemocontainerregistry.azurecr.io/pa-submission-workflow-api@sha256:b8e80df8f361152ce9f0bc2d0ac683f96774f998d47ed99648b5659722e03145 pa-submission-workflow-api
      working-directory: .

    - name: Push Docker image to Azure Container Registry
      run: |
        docker push everestdemocontainerregistry.azurecr.io/pa-submission-workflow-api:1
        
    - name: Display signing results
      if: success()
      run: echo "Docker image signing successful!"
    
    - name: Display signing failure
      if: failure()
      run: echo "Docker image signing failed. Please check the signing key and configuration."
